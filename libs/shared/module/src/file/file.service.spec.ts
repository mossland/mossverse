import { FileService } from "./file.service";
import { TestSystem } from "@shared/test-server";
import { FileModule } from "./file.module";

import * as sample from "../sample";
import * as db from "../db";
import * as srv from "../srv";
import * as gql from "../gql";
import { S3Service } from "./s3/s3.service";
import { registerModules } from "../module";

describe("File Service", () => {
  const system = new TestSystem();
  let fileService: FileService;
  let s3Service: S3Service;
  beforeAll(async () => {
    const app = await system.init(registerModules);
    fileService = app.get<FileService>(FileService);
    s3Service = app.get<S3Service>(S3Service);
  });
  afterAll(async () => await system.terminate());
  let file: db.File.Doc;
  let input: gql.FileStream;
  it("Create File", async () => {
    input = sample.fileStream();
    [file] = await fileService.addFiles([input], "test", "test");

    expect(file.status).toEqual("active");
    const filenames = await s3Service.getFileList();
    expect(filenames.some((filename) => filename.includes(file.filename))).toBeTruthy();
  });
  it("Remove File", async () => {
    file = await fileService.remove(file._id);
    expect(file.status).toEqual("inactive");
    const filenames = await s3Service.getFileList();
    expect(filenames.some((filename) => filename.includes(file.filename))).toBeTruthy();
  });
  it("Get Json from URI", async () => {
    const uri = "https://api.dogesound.club/mate/7606";
    const data = await fileService.getJsonFromUri(uri);
    expect(data).toHaveProperty("image");
    expect(data).toHaveProperty("attributes");
  });
  it("Get Encoded Json from URI", async () => {
    const uri =
      "data:application/json;base64,eyJ0b2tlbklkIjoxLCJuYW1lIjoiIzEgRGVuaXNlIEJhcnJldHQiLCJleHRlcm5hbF91cmwiOiJodHRwczovL2RvZ2Vzb3VuZC5jbHViLyIsImRlc2NyaXB0aW9uIjoiQmlhc2VkIE1hdGUgQ3ljbGUgU2hvcCwgd2Ugc2VsbCBiaWtlcyBhbmQgdGltZS4iLCJhdHRyaWJ1dGVzIjpbeyJ0cmFpdF90eXBlIjoiTGV2ZWwiLCJ2YWx1ZSI6MX0seyJ0cmFpdF90eXBlIjoiQmFja2dyb3VuZCIsInZhbHVlIjoiWWVsbG93In0seyJ0cmFpdF90eXBlIjoiQm9keSIsInZhbHVlIjoiU3VuZmxvd2VyIn0seyJ0cmFpdF90eXBlIjoiRXllcyIsInZhbHVlIjoiTm9uZSJ9LHsidHJhaXRfdHlwZSI6IkZhY2UgRGV0YWlsIiwidmFsdWUiOiJOb25lIn0seyJ0cmFpdF90eXBlIjoiSGFpciBCYW5kIiwidmFsdWUiOiJOb25lIn0seyJ0cmFpdF90eXBlIjoiSGFpciBjb2xvciIsInZhbHVlIjoiTm9uZSJ9LHsidHJhaXRfdHlwZSI6Ik1vdXRoIiwidmFsdWUiOiJOb25lIn0seyJ0cmFpdF90eXBlIjoiRWFycmluZyIsInZhbHVlIjoiTm9uZSJ9LHsidHJhaXRfdHlwZSI6IkhhdCIsInZhbHVlIjoiTm9uZSJ9LHsidHJhaXRfdHlwZSI6IkdsYXNzZXMiLCJ2YWx1ZSI6Ik5vbmUifSx7InRyYWl0X3R5cGUiOiJDbG90aGVzIiwidmFsdWUiOiJSZWQtTGVhdGhlci1KYWNrZXQifSx7InRyYWl0X3R5cGUiOiJJdGVtIiwidmFsdWUiOiJOb25lIn0seyJ0cmFpdF90eXBlIjoiTmVja2xhY2UiLCJ2YWx1ZSI6Ik5vbmUifSx7InRyYWl0X3R5cGUiOiJMYXN0IE5hbWUiLCJ2YWx1ZSI6IkJhcnJldHQifV0sImltYWdlIjoiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCd2NtVnpaWEoyWlVGemNHVmpkRkpoZEdsdlBTSjRUV2x1V1UxcGJpQnRaV1YwSWlCMmFXVjNRbTk0UFNJd0lEQWdNalFnTWpRaUlIaHRiRzV6UFNKb2RIUndPaTh2ZDNkM0xuY3pMbTl5Wnk4eU1EQXdMM04yWnlJK1BIQmhkR2dnWkQwaVRURTRJRGxvTVhZeGFERjJNV2d0TVhZeGFERjJNbWd0TVhZeWFDMHlkakZvTFRGMkxURm9MVEYyTVdndE1YWXhhREoyTVdneWRqRm9NWFl4YURGMk1XZ3hkak5vTkZZd1NEQjJNalZvTkhZdE0yZ3hkaTB4YURGMkxURm9NWFl0TVdneWRpMHhhREoyTFRKb0xURjJNVWc1ZGkweVNEaDJMVEZJTjNZdE1XZ3hkaTB4U0RkMkxURm9NVlk1YURGV09FZzRWamRvTWxZMWFERjJNV2d5VmpSb01YWXhhREpXTkdneGRqSm9NVnB0TVNBd1ZqaG9NWFl4V2swNUlEUm9NWFl4U0RsYUlpQnpkSGxzWlQwaVptbHNiRG9qWmpaak9UUTJJaTgrUEhCaGRHZ2daRDBpVFRnZ01URjJNV2d4ZGkweFdtMHhJREpJT0hZeGFERmFiVEVnTW5ZdE1VZzVkakZhYlRrdE1YWXRNV2d0TVhZeFdpSWdjM1I1YkdVOUltWnBiR3c2STJZMll6azBOaUl2UGp4d1lYUm9JR1E5SWswMElESTFhREYyTFROSU5GcHRNUzB6YURGMkxURklOVnB0TVMweGFERjJMVEZJTmxwdE5TMHpTRGwyTVVnM2RqRm9Nbll5YURGMkxUSm9NVnB0TFRJZ05uWXRNVWczZGpGYUlpQnpkSGxzWlQwaVptbHNiRG9qWW1Nd01EQXdJaTgrUEhCaGRHZ2daRDBpVFRFeElESXdkakpvTFRGMk1XZ3hkakpvTVhZdE5WcHRNeUF6YURGMkxURm9MVEYyTFRKb0xURjJOV2d4V2lJZ2MzUjViR1U5SW1acGJHdzZJMkpqTURBd01DSXZQanh3WVhSb0lHUTlJazB4TkNBeU1HZ3hkakpvTVhZdE1tZ3lkaTB4YUMweWRpMHhhQzB5V20wMElEUjJMVEZvTFRKMk1WcHRNQzB6YURGMkxURm9MVEZhYlRJZ01YWXRNV2d0TVhZeFdtMHdJRE5vTVhZdE0yZ3RNVm9pSUhOMGVXeGxQU0ptYVd4c09pTmlZekF3TURBaUx6NDhjR0YwYUNCa1BTSk5OU0F5TldneGRpMHpTRFZhYlRJdE5FZzJkakZvTVZwdE1DQXdhREoyTFRGSU4xcHRNQ0F6ZGpGb01uWXRNVnB0TXkweWFERjJMVEpvTFRGYWJUVXRNbWd0TVhZeWFERmFiVE1nTUdndE1uWXhhREphYlRBZ05YWXRNV2d0TW5ZeFdtMHhMVFJvTFRGMk1XZ3hXbTB3SURSb01YWXRNMmd0TVZvaUlITjBlV3hsUFNKbWFXeHNPaU5sTlRBeU1ESWlMejQ4Y0dGMGFDQmtQU0pOTnlBeU5YWXRNbWd5ZGpKb01uWXRNbWd0TVhZdE1VZzVkaTB4U0RkMk1VZzJkak5hYlRrdE0yZ3RNWFl4YUMweGRqSm9Nbll0TW1neWRqSm9NWFl0TTJndE1YWXRNV2d0TWxvaUlITjBlV3hsUFNKbWFXeHNPbkpsWkNJdlBqeHdZWFJvSUdROUlrMDNJREV4ZGpGb01YWXRNVnB0TXkwelZqZElPWFl4V20wd0lETjJMVEZJT1hZeFdtMHlJRE4yTFRGSU9YWXhXbTB0TWlBeWRpMHhTRGwyTVZwdE1TMHhNRlkxYUMweGRqRmFiVEVnTTFZNGFDMHlkakZhYlMweExUSm9NVlkyYUMweFdtMHdJRGwyTVdneGRpMHhXbTB5SURCMkxUSm9MVEYyTWxwdE1TMHhkakZvTVhZdE1WcHRNaTA1YURGV05XZ3RNbll6YURGYWJUSWdPSFl0TVdndE1uWXhXbTB4TFRWb0xUSjJNV2d5V20wdE1TQTFkakZvTVhZdE1WcHRNaTAyYUMweGRqRm9NVm9pSUhOMGVXeGxQU0ptYVd4c09pTmxOV0V6TUdZaUx6NDhjR0YwYUNCa1BTSk5OeUF4TTNZeGFERjJMVEZhYlRrZ01uWXhhREYyTFRGYUlpQnpkSGxzWlQwaVptbHNiRG9qWkdZNVpURXdJaTgrUEhCaGRHZ2daRDBpVFRnZ04zWXhhREZXTjFwdE1TQTBkaTB4U0RoMk1WcHRNQzB5YURGV09FZzVXbTB5SUROMkxURklPWFl4V20wdE1pQTFhREYyTFRGSU9WcHRNaTA0YUMweGRqRm9NVnB0TFRFZ04yZ3hkaTB5YUMweFdtMHlMVGhvTVZZM2FERldOR2d0TVhZeWFDMHhXbTB4SURob01YWXRNV2d0TVZwdE1TQXhhREYyTFRGb0xURmFiVEl0TTJndE1YWXlhREZhYlRFdE5sWTNhREZXTm1ndE1uWXlXbTB0TVNBNGRqRm9NWFl0TVZwdE15MDFhQzB5ZGpGb01scHRMVElnTTNZeGFERjJMVEZhYlRNdE1YWXRNV2d0TVhZeFdpSWdjM1I1YkdVOUltWnBiR3c2STJVMFpHWTBOeUl2UGp4d1lYUm9JR1E5SWswNElEbDJNV2d5VmpsYWJUTWdOSFl0TVVnNGRqRmFiUzB4TFRkMk1tZ3lWamRvTFRGV05scHRNQ0EwZGpGb01YWXRNVnB0TVNBMGRqSm9NWFl0TWxwdE15MDNhQzB4ZGpGb01sWTFhQzB4V20wMElESldOMmd0TVhZeGFDMHhkakZhYlMweElEWjJMVEZvTFRGMk1WcHRNeTAxYUMwemRqRm9NMXB0TFRFZ01tZ3RNbll4YURKYWJTMHhJRE5vTFRGMk1XZ3hXaUlnYzNSNWJHVTlJbVpwYkd3NkkyUXpOekV3WlNJdlBqeHdZWFJvSUdROUlrMDVJREUxZGkweFNEaDJNVnB0T1NBd2RqRm9NWFl0TVZvaUlITjBlV3hsUFNKbWFXeHNPaU5rWldRM05EVWlMejQ4Y0dGMGFDQmtQU0pOT1NBMWFERldORWc1V2lJZ2MzUjViR1U5SW1acGJHdzZJMlJtT1dRd1ppSXZQanh3WVhSb0lHUTlJazB4TWlBNWFDMHhkalJvTVZwdE1DMHhkakZvTkZZNFdtMHhJRFoyTFRGb0xURjJNVnB0TWlBd2FDMHlkakZvTWxwdE1TQXdkaTB4YUMweGRqRmFiVEF0TVdneFZqbG9MVEZhSWlCemRIbHNaVDBpWm1sc2JEb2pOVE15TURCaUlpOCtQSEJoZEdnZ1pEMGlUVEV5SURFM2FDMHhkak5vTVZwdE1TMHhkalJvTVhZdE5Gb2lJSE4wZVd4bFBTSm1hV3hzT2lNd1l6QmpNR01pTHo0OGNHRjBhQ0JrUFNKTk1UTWdPV2d0TVhZeGFERmFiUzB4SURKMk1XZ3hkaTB4V20weUxURm9MVEYyTVdneFdtMHRNU0F6YURGMkxURm9MVEZhYlRJdE5HZ3RNWFl4YURGYWJTMHhJREoyTVdneGRpMHhXbTB4SURKb0xURjJNV2d4V20wd0xUSm9NWFl0TVdndE1WcHRNQ0F4ZGpGb01YWXRNVm9pSUhOMGVXeGxQU0ptYVd4c09pTTRZalUwTVRBaUx6NDhjR0YwYUNCa1BTSk5NVE1nTVRGMkxURm9MVEYyTVZwdExURWdNWFl4YURGMkxURmFiVEl0TTJndE1YWXhhREZhYlRBZ00zWXRNV2d0TVhZeFdtMHRNU0F5YURGMkxURm9MVEZhYlRFdE5IWXhhREYyTFRGYWJUQWdNMmd4ZGkweGFDMHhXbTB4TFRSMk1XZ3hWamxhYlRFZ00zWXRNV2d0TVhZeFdpSWdjM1I1YkdVOUltWnBiR3c2SXpkbU5HUXhNQ0l2UGp4d1lYUm9JR1E5SWsweE1pQXhPV2d4ZGkwemFDMHhXaUlnYzNSNWJHVTlJbVpwYkd3Nkl6UXhOekl4TkNJdlBqeHdZWFJvSUdROUlrMHhNaUF4T1hZeGFERjJMVEZhSWlCemRIbHNaVDBpWm1sc2JEb2pNakV6WkRBNElpOCtQSEJoZEdnZ1pEMGlUVEV5SURJd2RqRm9NWFl0TVZvaUlITjBlV3hsUFNKbWFXeHNPaU5sWW1WaVpXSWlMejQ4Y0dGMGFDQmtQU0pOTVRJZ01qVm9NWFl0TkdndE1Wb2lJSE4wZVd4bFBTSm1hV3hzT2lObVptWWlMejQ4Y0dGMGFDQmtQU0pOTVRZZ05IWXhhREZXTkZvaUlITjBlV3hsUFNKbWFXeHNPaU5rT1dRME5EUWlMejQ4Y0dGMGFDQmtQU0pOTVRrZ01UTjJNV2d4ZGkweFdpSWdjM1I1YkdVOUltWnBiR3c2STJObE5tVXdaaUl2UGp3dmMzWm5QZz09In0=";
    const data = await fileService.getJsonFromUri(uri);
    expect(data).toHaveProperty("image");
    expect(data).toHaveProperty("attributes");
  });
  it("Create File from URI", async () => {
    const uri =
      "https://images.chosun.com/resizer/fo-0AnY_2j3QZ2DbEuxxVc0VSZQ=/616x0/smart/cloudfront-ap-northeast-1.images.arcpublishing.com/chosun/6Y6TZ5MYRVGFDNVP6FAEPRLIKQ.jpg";
    const file = await fileService.addFileFromUri(uri, "test", "test");
    expect(file).toHaveProperty("_id");
  });
  it("Create File from URI(IPFS)", async () => {
    const uri = "ipfs://QmarGRwVKPaCe2s5QSSTMEdbYDwKxFz6bAn58YZPPcWc7k/1";
    const file = await fileService.addFileFromUri(uri, "test", "test");
    expect(file).toHaveProperty("_id");
  });
  it("Create File from Encoded", async () => {
    const uri =
      "data:image/svg+xml;base64,PHN2ZyBwcmVzZXJ2ZUFzcGVjdFJhdGlvPSJ4TWluWU1pbiBtZWV0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHBhdGggZD0iTTE4IDloMXYxaDF2MWgtMXYxaDF2MmgtMXYyaC0ydjFoLTF2LTFoLTF2MWgtMXYxaDJ2MWgydjFoMXYxaDF2MWgxdjNoNFYwSDB2MjVoNHYtM2gxdi0xaDF2LTFoMXYtMWgydi0xaDJ2LTJoLTF2MUg5di0ySDh2LTFIN3YtMWgxdi0xSDd2LTFoMVY5aDFWOEg4VjdoMlY1aDF2MWgyVjRoMXYxaDJWNGgxdjJoMVptMSAwVjhoMXYxWk05IDRoMXYxSDlaIiBzdHlsZT0iZmlsbDojZjZjOTQ2Ii8+PHBhdGggZD0iTTggMTF2MWgxdi0xWm0xIDJIOHYxaDFabTEgMnYtMUg5djFabTktMXYtMWgtMXYxWiIgc3R5bGU9ImZpbGw6I2Y2Yzk0NiIvPjxwYXRoIGQ9Ik00IDI1aDF2LTNINFptMS0zaDF2LTFINVptMS0xaDF2LTFINlptNS0zSDl2MUg3djFoMnYyaDF2LTJoMVptLTIgNnYtMUg3djFaIiBzdHlsZT0iZmlsbDojYmMwMDAwIi8+PHBhdGggZD0iTTExIDIwdjJoLTF2MWgxdjJoMXYtNVptMyAzaDF2LTFoLTF2LTJoLTF2NWgxWiIgc3R5bGU9ImZpbGw6I2JjMDAwMCIvPjxwYXRoIGQ9Ik0xNCAyMGgxdjJoMXYtMmgydi0xaC0ydi0xaC0yWm00IDR2LTFoLTJ2MVptMC0zaDF2LTFoLTFabTIgMXYtMWgtMXYxWm0wIDNoMXYtM2gtMVoiIHN0eWxlPSJmaWxsOiNiYzAwMDAiLz48cGF0aCBkPSJNNSAyNWgxdi0zSDVabTItNEg2djFoMVptMCAwaDJ2LTFIN1ptMCAzdjFoMnYtMVptMy0yaDF2LTJoLTFabTUtMmgtMXYyaDFabTMgMGgtMnYxaDJabTAgNXYtMWgtMnYxWm0xLTRoLTF2MWgxWm0wIDRoMXYtM2gtMVoiIHN0eWxlPSJmaWxsOiNlNTAyMDIiLz48cGF0aCBkPSJNNyAyNXYtMmgydjJoMnYtMmgtMXYtMUg5di0xSDd2MUg2djNabTktM2gtMXYxaC0xdjJoMnYtMmgydjJoMXYtM2gtMXYtMWgtMloiIHN0eWxlPSJmaWxsOnJlZCIvPjxwYXRoIGQ9Ik03IDExdjFoMXYtMVptMy0zVjdIOXYxWm0wIDN2LTFIOXYxWm0yIDN2LTFIOXYxWm0tMiAydi0xSDl2MVptMS0xMFY1aC0xdjFabTEgM1Y4aC0ydjFabS0xLTJoMVY2aC0xWm0wIDl2MWgxdi0xWm0yIDB2LTJoLTF2MlptMS0xdjFoMXYtMVptMi05aDFWNWgtMnYzaDFabTIgOHYtMWgtMnYxWm0xLTVoLTJ2MWgyWm0tMSA1djFoMXYtMVptMi02aC0xdjFoMVoiIHN0eWxlPSJmaWxsOiNlNWEzMGYiLz48cGF0aCBkPSJNNyAxM3YxaDF2LTFabTkgMnYxaDF2LTFaIiBzdHlsZT0iZmlsbDojZGY5ZTEwIi8+PHBhdGggZD0iTTggN3YxaDFWN1ptMSA0di0xSDh2MVptMC0yaDFWOEg5Wm0yIDN2LTFIOXYxWm0tMiA1aDF2LTFIOVptMi04aC0xdjFoMVptLTEgN2gxdi0yaC0xWm0yLThoMVY3aDFWNGgtMXYyaC0xWm0xIDhoMXYtMWgtMVptMSAxaDF2LTFoLTFabTItM2gtMXYyaDFabTEtNlY3aDFWNmgtMnYyWm0tMSA4djFoMXYtMVptMy01aC0ydjFoMlptLTIgM3YxaDF2LTFabTMtMXYtMWgtMXYxWiIgc3R5bGU9ImZpbGw6I2U0ZGY0NyIvPjxwYXRoIGQ9Ik04IDl2MWgyVjlabTMgNHYtMUg4djFabS0xLTd2MmgyVjdoLTFWNlptMCA0djFoMXYtMVptMSA0djJoMXYtMlptMy03aC0xdjFoMlY1aC0xWm00IDJWN2gtMXYxaC0xdjFabS0xIDZ2LTFoLTF2MVptMy01aC0zdjFoM1ptLTEgMmgtMnYxaDJabS0xIDNoLTF2MWgxWiIgc3R5bGU9ImZpbGw6I2QzNzEwZSIvPjxwYXRoIGQ9Ik05IDE1di0xSDh2MVptOSAwdjFoMXYtMVoiIHN0eWxlPSJmaWxsOiNkZWQ3NDUiLz48cGF0aCBkPSJNOSA1aDFWNEg5WiIgc3R5bGU9ImZpbGw6I2RmOWQwZiIvPjxwYXRoIGQ9Ik0xMiA5aC0xdjRoMVptMC0xdjFoNFY4Wm0xIDZ2LTFoLTF2MVptMiAwaC0ydjFoMlptMSAwdi0xaC0xdjFabTAtMWgxVjloLTFaIiBzdHlsZT0iZmlsbDojNTMyMDBiIi8+PHBhdGggZD0iTTEyIDE3aC0xdjNoMVptMS0xdjRoMXYtNFoiIHN0eWxlPSJmaWxsOiMwYzBjMGMiLz48cGF0aCBkPSJNMTMgOWgtMXYxaDFabS0xIDJ2MWgxdi0xWm0yLTFoLTF2MWgxWm0tMSAzaDF2LTFoLTFabTItNGgtMXYxaDFabS0xIDJ2MWgxdi0xWm0xIDJoLTF2MWgxWm0wLTJoMXYtMWgtMVptMCAxdjFoMXYtMVoiIHN0eWxlPSJmaWxsOiM4YjU0MTAiLz48cGF0aCBkPSJNMTMgMTF2LTFoLTF2MVptLTEgMXYxaDF2LTFabTItM2gtMXYxaDFabTAgM3YtMWgtMXYxWm0tMSAyaDF2LTFoLTFabTEtNHYxaDF2LTFabTAgM2gxdi0xaC0xWm0xLTR2MWgxVjlabTEgM3YtMWgtMXYxWiIgc3R5bGU9ImZpbGw6IzdmNGQxMCIvPjxwYXRoIGQ9Ik0xMiAxOWgxdi0zaC0xWiIgc3R5bGU9ImZpbGw6IzQxNzIxNCIvPjxwYXRoIGQ9Ik0xMiAxOXYxaDF2LTFaIiBzdHlsZT0iZmlsbDojMjEzZDA4Ii8+PHBhdGggZD0iTTEyIDIwdjFoMXYtMVoiIHN0eWxlPSJmaWxsOiNlYmViZWIiLz48cGF0aCBkPSJNMTIgMjVoMXYtNGgtMVoiIHN0eWxlPSJmaWxsOiNmZmYiLz48cGF0aCBkPSJNMTYgNHYxaDFWNFoiIHN0eWxlPSJmaWxsOiNkOWQ0NDQiLz48cGF0aCBkPSJNMTkgMTN2MWgxdi0xWiIgc3R5bGU9ImZpbGw6I2NlNmUwZiIvPjwvc3ZnPg==";
    const file = await fileService.addFileFromUri(uri, "test", "test");
    expect(file).toHaveProperty("_id");
  });
});
